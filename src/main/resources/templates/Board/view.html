<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org" lang="en" >

<!--<head th:replace="fragments/header :: header" />-->
    <head>
        <title>게시글 상세 페이지</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="/css/bootstrap.min.css">
        <link rel="stylesheet" href="/css/board.css">
        <link rel="stylesheet" href="/css/custom.css">
    </head>
    <body>
    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>

    <script th:inline="javascript">
        $(document).ready(function () {
            $("#attachFiles").attr("change-files", false);

            $(".delete-link").click(function (event) {
                event.preventDefault(); // 기본 클릭 동작 방지
                const fileId = parseInt($(this).attr('id'));
                const clickedLink = $(this);
                deleteFile(fileId, clickedLink);
            });

        function deleteFile(fileId, clickedLink) {
            $.ajax({
                type: "POST",
                url: "/delete/" + fileId,
                success: function (response) {
                    if (response === "success") {
                        // alert("파일이 삭제되었습니다.");
                        // 삭제 성공시 태그 삭제
                        $(clickedLink).parent().remove();
                    } else {
                        alert("파일 삭제 중 오류가 발생했습니다.");
                    }
                },
                error: function () {
                    alert("파일 삭제 중 오류가 발생했습니다.");
                }
            });
        }

        $("#attachFiles").on("change", function () {
            $("#attachFiles").attr("change-files", true);
            var fileList = this.files; // 'this'를 통해 선택한 파일들 가져오기
            const selectedFilesList = $("#selectedFiles");

            console.log(fileList , selectedFilesList);

            // 선택한 파일 목록 만들기
            selectedFilesList.empty(); // 기존 목록 비우기
            const ul  = $("<ui>");

            for (let i = 0; i < fileList.length; i++) {
                const listItem = $("<li>");
                const link = $("<a>").text(fileList[i].name);
                const deleteLink = $("<a>")
                        .addClass("delete-link")
                        .text("x")
                        .css("color", "red")
                        .attr("data-index", i); // index 값 설정

                listItem.append(link.text(fileList[i].name)); // <a> 태그를 <li> 에 추가
                listItem.append(deleteLink);
                ul.append(listItem); // <ul> 안에 <li> 추가
                selectedFilesList.append(ul); // <div> 안에 추가
            }
        });
            // "x" 클릭시 <li> 삭제 (이벤트 위임) -WHY? 동적태그
            $("#selectedFiles").on("click", ".delete-link", function (event) {
                event.preventDefault(); // 기본 클릭 동작 방지

                const clickedLink = $(this);
                const deleteIndex = clickedLink.attr("data-index"); // 삭제할 index 추출

                $(clickedLink).parent().remove();

                updateFileInput(deleteIndex); // 파일 input 업데이트
                updateFileList(deleteIndex); // 변경된 input 에 맞춰서 새로 selectedFiles 뿌려주기

            });

            // 파일 input 태그에 업데이트  -> DataTransfer 로 fileList 새로 만들기
            function updateFileInput(deleteIndex) {

                const dataTransfer = new DataTransfer();
                var fileArray = Array.from($("#attachFiles")[0].files);
                fileArray.splice(deleteIndex,1); // 해당하는 index 파일을 배열에서 제거
                console.log("after splice=> ", fileArray);

                fileArray.forEach(file => { dataTransfer.items.add(file);});

                //남은 배열을 dataTransfer로 처리(Array -> FileList)
                $("#attachFiles")[0].files = dataTransfer.files;  // 제거 처리된 FileList를 돌려줌
                console.log("updateFileInput >> attachFiles ", $("#attachFiles")[0].files);
            }

            // 파일 목록 업데이트
            function updateFileList(deleteIndex) {

                const selectedFilesDiv = $("#selectedFiles");
                // 선택한 파일 목록 만들기
                selectedFilesList.empty(); // 기존 목록 비우기
                const ul  = $("<ui>");
                for (let i = 0; i < fileList.length; i++) {
                    const listItem = $("<li>");
                    const link = $("<a>").text(fileList[i].name);
                    const deleteLink = $("<a>")
                        .addClass("delete-link")
                        .text("x")
                        .css("color", "red")
                        .attr("data-index", i); // index 값 설정
                    listItem.append(link.text(fileList[i].name)); // <a> 태그를 <li> 에 추가
                    listItem.append(deleteLink);
                    ul.append(listItem); // <ul> 안에 <li> 추가
                    selectedFilesList.append(ul); // <div> 안에 추가
                }
            }
    });

        function edit(){
            $("input[name='title']").attr("readonly", false);
            $("textarea[name='content']").attr("readonly", false);
            $("#attachFiles").removeAttr("style");

            // 저장&삭제 버튼 활성화
            if($("#saveButton").css("display") === "none" && $("#deleteButton").css("display") === "none"){
                $('#saveButton').show();
                $('#deleteButton').show();
                // $('#cancelButton').show();
                $('#editButton').hide();
                $(".delete-link").show();
            }
        }
        function cancel(){
            location.href="/";
        }
        function deleteBoard(boardNo){
            console.log( "boardNo" + boardNo);
            const formObj = $("form");
            formObj.attr("action", "/Board/"+boardNo +"/delete");
            formObj.attr("method", "post");
            formObj.submit();
        }
    </script>

        <div th:replace="fragments/bodyHeader :: bodyHeader"></div>
        <div class="container" style="padding-top: 30px; width: 70%">
            <!--    <div th:replace="fragments/bodyHeader :: bodyHeader"/>-->
            <!--    th:action="@{/Board/{boardNo}/view (boardNo=${board.boardNo}) }"-->
            <form th:id="update-form" th:object="${boards}" method="post" class = "row g-3 fw-bolder" enctype="multipart/form-data">
                <div class="form-group col-12">
                    <h3>
                <span th:if="${#strings.equals(board.getCategory().name(), 'FREE')}" class="form-control-plaintext" th:style="${'display:inline;'}"> 자유게시판</span>
                <span th:if="${#strings.equals(board.getCategory().name(), 'NOTICE')}" class="form-control-plaintext" th:style="${'display:inline;'}">공지사항</span>
                <span th:if="${#strings.equals(board.getCategory().name(), 'QNA')}" class="form-control-plaintext" th:style="${'display:inline;'}">Q&A</span>
                    </h3>
                </div>
                <div class="form-group col-12">
                    <label th:for="boardNo">게시글 번호</label>
                    <span th:text="${board.boardNo}" class="form-control-plaintext" th:style="${'display:inline; margin-inline-start:5px'}"> </span>   <!--th:style="${'display:inline; margin-inline-start:5px'}"-->
                </div>
                <div class="form-group col-6">
                    <label th:for="regId">작성자</label>
                    <span th:text="${board.regId}" class="form-control-plaintext"  > 비어있음 </span>
                </div>
                <div class="form-group col-6">
                    <label th:for="regTime">작성일</label>
                    <span th:text="${#temporals.format(board.regTime, 'yyyy-MM-dd HH:mm:ss')}" class="form-control-plaintext" > 비어있음 </span>
                </div>
                <div class="form-group col-6">
                    <label th:for="modId">최종수정자</label>
                    <span th:text="${board.modId}" class="form-control-plaintext" > 비어있음 </span>
                </div>
                <div class="form-group col-6">
                    <label th:for="modTime">최종수정일</label>
                    <span th:text="${#temporals.format(board.modTime, 'yyyy-MM-dd HH:mm:ss')}" class="form-control-plaintext" > 비어있음 </span>
                </div>
                <div class="form-group col-12">
                    <label class="form-label" th:for="title">제목</label>
                    <input type="text" th:field="${board.title}"  class="form-control col-8" readonly>
                    <!--      <span th:text="${board.title}" class="form-control" >제목 없음 </span>-->
                </div>
                <div class="form-group col-12">
                    <label class="form-label" th:for="content">내용</label>
                    <textarea type="text" th:field="${board.content}"  class="form-control" readonly></textarea>
                    <!--      <span th:text="${board.content}" class="form-control" > 내용 없음 </span>-->
                </div>
                <div class="form-group col-12">
                    <label th:for="attachFiles">첨부파일</label>
                    <input type="file" id="attachFiles" name="attachFiles" multiple="multiple" class="form-control-file" th:style="${'display:none'}" />
                </div>
                <div class="form-group col-12" id="selectedFiles">
                    <ul>
                        <li th:each="file : ${board.files}">
                            <a th:href="@{/download/{id}(id=${file.id})}" th:text="${file.originalFileName}" th:id="file_+${file.id}"></a>
                            <a th:href="@{/delete/{id}(id=${file.id})}" th:text="x" th:style="${'color:red; display:none;'}" class="delete-link" th:id="${file.id}"></a>
                        </li>
                    </ul>
                </div>
                <div th:style="${'text-align: center'}">
                    <button type="button" class="btn btn-success col-auto" id="editButton" th:onclick="edit()"  th:style="${session.loginMember?.email == board.regId? 'display:inline-block' : 'display:none'}" >수정</button>
                    <button type="submit" class="btn btn-success col-auto" id="saveButton" style="display:none;">저장</button>
                    <button type="button" class="btn btn-danger col-auto" id="deleteButton" style="display:none;" th:onclick="'javascript:deleteBoard('+${board.boardNo}+')'" >삭제</button>
                    <!--    th:href="@{/Board/{boardNo}/edit (boardNo=${board.boardNo})}"-->
                    <button type="button" class="btn btn-warning col-auto" id="cancelButton" th:onclick="cancel()">목록</button>
                </div>
            </form>
            <br/>
        </div>

    </body>
</html>
